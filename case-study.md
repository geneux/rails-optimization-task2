# Задание 2. Case Study.

## Checklist
- [x] Построить и проанализировать отчёт гемом `memory_profiler`
- [x] Построить и проанализировать отчёт `ruby-prof` в режиме `Flat`;
- [x] Построить и проанализировать отчёт `ruby-prof` в режиме `Graph`;
- [x] Построить и проанализировать отчёт `ruby-prof` в режиме `CallStack`;
- [x] Построить и проанализировать отчёт `ruby-prof` в режиме `CallTree` c визуализацией в `QCachegrind`;
- [x] Построить и проанализировать текстовый отчёт `stackprof`;
- [x] Построить и проанализировать отчёт `flamegraph` с помощью `stackprof` и визуализировать его в `speedscope.app`;
- [x] Построить график потребления памяти в `valgrind massif visualier` и включить скриншот в описание вашего `PR`;
- [x] Написать тест, на то что программа укладывается в бюджет по памяти

## Начальные метрики в полном файле
* Время выполнения: **21 сек.** 
* Память: **2296 Мб**


## Feedback Loop

В начале будем использовать лимит во 20 000 строк.

### Итерация 1
#### какой отчёт показал главную точку роста
memory_profiler показал 1.68 Гб массивов и большое выделение объектов в `File.read ... .split`:
```
allocated memory by class
-----------------------------------
   1.68 GB  Array

allocated objects by location
-----------------------------------
   3250943  /home/dave/dev/rails-optimization-task2/src/work.rb:43
   
```
#### как вы решили её оптимизировать
Перейти к построчному чтению файла.
#### как изменилась метрика
`492 MB` => `110 MB`
#### как изменился отчёт профилировщика
Потребление перенеслось в другую строку, теперь это наполнение массива `sessions`. Однако, массивов все еще много:
```
allocated objects by location
-----------------------------------
    221432  /home/dave/dev/rails-optimization-task2/src/work.rb:138

 => { 'dates' => user.sessions.map{|s| s['date']}.map {|d| Date.parse(d)}.sort.reverse.map { |d| d.iso8601 } }

allocated memory by class
-----------------------------------
   1.65 GB  Array
```

### Итерация 2

> TODO
